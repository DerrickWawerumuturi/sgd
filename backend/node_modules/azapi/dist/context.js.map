{"version":3,"sources":["../src/context.js"],"names":["Promise","__applyHooks","then","$then","catch","$catch","finally","$finally","prototype","Object","assign","onResolve","onReject","call","wrap","onCatch","onFinally","f","context","useContext","prevContext","UNSAFE_setContext","apply","arguments","currentContext","applyInterface","on","name","handler","handlers","Set","add","delete","emit","args","Array","from","reduce","prev","newContext","UNSAFE_createContext","req","res","props"],"mappings":"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","sourcesContent":["if (!Promise.__applyHooks) {\n  Promise.__applyHooks = true;\n  const {then: $then, catch: $catch, finally: $finally} = Promise.prototype;\n\n  Object.assign(Promise.prototype, {\n    then(onResolve, onReject) {\n      return $then.call(this, wrap(onResolve), wrap(onReject));\n    },\n    catch(onCatch) {\n      return $catch.call(this, wrap(onCatch));\n    },\n    finally(onFinally) {\n      return $finally.call(this, wrap(onFinally));\n    },\n  });\n}\n\nfunction wrap(f) {\n  if (!f) {\n    return f;\n  }\n  const context = useContext();\n  return function () {\n    let prevContext = useContext();\n    try {\n      UNSAFE_setContext(context);\n      return f.apply(this, arguments);\n    } finally {\n      UNSAFE_setContext(prevContext);\n    }\n  };\n}\n\nlet currentContext;\n\nexport function useContext() {\n  return currentContext;\n}\n\nexport function applyInterface(context) {\n  const on = {};\n\n  Object.assign(context, {\n    on(name, handler) {\n      let handlers = on[name];\n      if (!handlers) {\n        on[name] = handlers = new Set();\n      }\n      handlers.add(handler);\n      return () => handlers.delete(handler);\n    },\n    emit(name, args = context) {\n      const handlers = on[name];\n\n      if (!handlers) {\n        return;\n      }\n\n      return Array.from(handlers).reduce((prev, handler) => {\n        if (prev && typeof prev.then === 'function') {\n          return prev.finally(() => {\n            return handler(args);\n          });\n        } else {\n          return handler(args);\n        }\n      }, null);\n    },\n  });\n\n  return context;\n}\n\nexport function UNSAFE_setContext(newContext) {\n  currentContext = newContext;\n}\n\nexport function UNSAFE_createContext(req, res, props) {\n  return applyInterface({\n    req,\n    res,\n    ...props,\n  });\n}\n"],"file":"context.js"}