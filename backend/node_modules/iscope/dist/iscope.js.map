{"version":3,"sources":["../src/iscope.js"],"names":["activeScopes","Set","unset","defaultScope","createScope","init","currentValue","getValue","iscope","arguments","length","scope","func","args","context","previousValue","add","apply","delete","Object","assign","__iscope","reset","Promise","__prevIScopeHook","prototype","then","$then","catch","$catch","finally","$finally","onResolve","onReject","call","wrap","onCatch","onFinally","f","size","scopes","Array","from","map","applyScopes","reduce","value","firstArg","isArray"],"mappings":"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","sourcesContent":["const activeScopes = new Set();\nconst unset = {};\nconst defaultScope = createScope();\n\nfunction createScope(init) {\n  let currentValue = unset;\n\n  function getValue() {\n    if (currentValue === unset) {\n      currentValue = typeof init === 'function' ? init() : init;\n    }\n    return currentValue;\n  }\n\n  function iscope() {\n    if (arguments.length) {\n      // iscope(scope, func, args, context);\n      const [scope, func, args = [], context = null] = arguments;\n      const previousValue = getValue();\n      activeScopes.add(iscope);\n      try {\n        currentValue = scope;\n        return func.apply(context, args);\n      } finally {\n        currentValue = previousValue;\n        activeScopes.delete(iscope);\n      }\n    }\n    // iscope();\n    else {\n      return getValue();\n    }\n  }\n\n  Object.assign(iscope, {\n    __iscope: true,\n    reset() {\n      currentValue = unset;\n    },\n  });\n\n  return iscope;\n}\n\nif (Promise.__prevIScopeHook) {\n  Object.assign(Promise.prototype, Promise.__prevIScopeHook);\n}\n\nconst {then: $then, catch: $catch, finally: $finally} = Promise.prototype;\nPromise.__prevIScopeHook = {then: $then, catch: $catch, finally: $finally};\n\nObject.assign(Promise.prototype, {\n  then(onResolve, onReject) {\n    return $then.call(this, wrap(onResolve), wrap(onReject));\n  },\n  catch(onCatch) {\n    return $catch.call(this, wrap(onCatch));\n  },\n  finally(onFinally) {\n    return $finally.call(this, wrap(onFinally));\n  },\n});\n\nfunction wrap(f) {\n  if (!f) {\n    return f;\n  }\n\n  if (!activeScopes.size) {\n    return f;\n  }\n\n  const scopes = Array.from(activeScopes).map((iscope) => [iscope, iscope()]);\n\n  return function () {\n    return applyScopes(scopes, f, arguments, this);\n  };\n}\n\nfunction applyScopes(scopes, f, args, context) {\n  return scopes.reduce(\n    (func, [scope, value]) => () => scope(value, func, args, context),\n    f,\n  )();\n}\n\nexport default function () {\n  if (!arguments.length) {\n    return defaultScope();\n  }\n  const firstArg = arguments[0];\n  if (arguments.length === 1) {\n    return createScope(firstArg);\n  }\n  // iscope(listOfScopes, func)\n  if (\n    Array.isArray(firstArg) &&\n    Array.isArray(firstArg[0]) &&\n    typeof firstArg[0][0] === 'function' &&\n    firstArg[0][0].__iscope\n  ) {\n    const [scopes, func, args = [], context = null] = arguments;\n\n    return applyScopes(scopes, func, args, context);\n  }\n\n  return defaultScope(...arguments);\n}\n"],"file":"iscope.js"}